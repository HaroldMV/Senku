-- METODOS PRODUCTOS

--MANTENIMIENTO PRODUCTOS

CREATE PROC SP_MANTENIMIENTOPRODUCTO(@IDPROD CHAR(10),@NOM_PROD  VARCHAR(30),@DES_PROD VARCHAR(100), @TIEMP_ENVIO     VARCHAR(20),
									 @FECHA_PUB VARCHAR(25), @PRECIO SMALLMONEY, @STOCK  INT, @IM_PROD    VARCHAR(255), @ID_CATEG CHAR(5))    
AS
	MERGE INTO TB_RODUCTOS AS TARGET 
	USING(SELECT @IDPROD,@NOM_PROD,@DES_PROD,@TIEMP_ENVIO,@FECHA_PUB,@PRECIO,@STOCK,@IM_PROD,@ID_CATEG) 
	AS SOURCE(ID_PROD, NOM_PROD, DES_PROD, TIEMP_ENVIO, FECHA_PUB, PRECIO, STOCK, IM_PROD, ID_CATEG )
	ON (TARGET.ID_PROD=SOURCE.ID_PROD)
	WHEN MATCHED THEN 
		UPDATE SET TARGET.ID_PROD=SOURCE.ID_PROD,
		           TARGET.NOM_PROD=SOURCE.NOM_PROD,
				   TARGET.DES_PROD=SOURCE.DES_PROD,
				   TARGET.TIEMP_ENVIO=SOURCE.TIEMP_ENVIO,
				   TARGET.FECHA_PUB=SOURCE.FECHA_PUB,
				   TARGET.PRECIO=SOURCE.PRECIO,
				   TARGET.STOCK=SOURCE.STOCK,
				   TARGET.IM_PROD=SOURCE.IM_PROD,
				   TARGET.ID_CATEG=SOURCE.ID_CATEG
	WHEN NOT MATCHED THEN 
	INSERT VALUES(SOURCE.ID_PROD,SOURCE.NOM_PROD,SOURCE.DES_PROD,SOURCE.TIEMP_ENVIO,SOURCE.FECHA_PUB,SOURCE.PRECIO,SOURCE.STOCK,SOURCE.IM_PROD,SOURCE.ID_CATEG);
GO



CREATE PROC SP_LISTAPRODUCTO
AS
	SELECT P.ID_PROD, P.NOM_PROD, P.DES_PROD, P.TIEMP_ENVIO, P.FECHA_PUB, P.PRECIO, P.STOCK, G.NOM_CATEG, P.IM_PROD
	FROM TB_RODUCTOS p JOIN TB_CATEGORIA G ON P.ID_CATEG = G.ID_CATEG
GO


CREATE PROC SP_LISTAPRODUCTSOG
AS
	SELECT * FROM TB_RODUCTOS
GO


CREATE PROC SP_LISTACATEGORIA
AS
	SELECT * FROM TB_CATEGORIA
GO

CREATE PROC SP_ELIMINARPRODUCTO(@ID CHAR(10))
AS
	DELETE FROM TB_RODUCTOS WHERE ID_PROD = @ID
GO



-----------------------------------------------------------------------------------------------------------------

--METODOS DE USUARIO

--LISTA USUARIOS--
CREATE PROC SP_LISTAUSUARIO
AS
	SELECT U.ID_USU,U.NOMBRES,U.NOM_USU,U.PASS_USU,U.CORREO_USU,U.FECHA_NACI,U.SEXO_USU,P.NOMBRE_PA
	FROM TB_USUARIO U  JOIN TB_PAIS P ON U.ID_PAIS=P.ID_PAIS
	
GO

--LISTA USUARIO ORIGINAL
CREATE PROC SP_LISTAUSUARIOORIGINAL
AS
	SELECT *
	FROM TB_USUARIO 
GO

--LISTA DE PAISES
CREATE PROC SP_LISTAPAISES
AS
	SELECT * FROM TB_PAIS
GO

--MANTENIMIENTOUSUARIO--
CREATE PROC SP_MANTENIMIENTOUSUARIO(@ID_USU CHAR(8),
@NOMBRES    VARCHAR(30),
@NOM_USU    VARCHAR(10),
@PASS_USU   VARCHAR(15),
@CORREO_USU VARCHAR(25),
@FECHA_NACI DATE,
@SEXO_USU   VARCHAR(10),
@ID_PAIS    CHAR(4) )
AS
	MERGE INTO TB_USUARIO AS TARGET 
	USING(SELECT @ID_USU,@NOMBRES,@NOM_USU,@PASS_USU,@CORREO_USU,@FECHA_NACI,@SEXO_USU,@ID_PAIS)
	     AS SOURCE(ID_USU,NOMBRES,NOM_USU,PASS_USU,CORREO_USU,FECHA_NACI,SEXO_USU,ID_PAIS)
	ON (TARGET.ID_USU=SOURCE.ID_USU)
	WHEN MATCHED THEN 
		UPDATE SET TARGET.ID_USU=SOURCE.ID_USU,TARGET.NOMBRES=SOURCE.NOMBRES,
				   TARGET.NOM_USU=SOURCE.NOM_USU,TARGET.PASS_USU=SOURCE.PASS_USU,TARGET.CORREO_USU=SOURCE.CORREO_USU,
				   TARGET.FECHA_NACI=SOURCE.FECHA_NACI,
				   TARGET.SEXO_USU=SOURCE.SEXO_USU,TARGET.ID_PAIS=SOURCE.ID_PAIS
	WHEN NOT MATCHED THEN 
	INSERT VALUES(SOURCE.ID_USU,SOURCE.NOMBRES,SOURCE.NOM_USU,SOURCE.PASS_USU,SOURCE.CORREO_USU,SOURCE.FECHA_NACI,SOURCE.SEXO_USU,
	SOURCE.ID_PAIS);
GO

--SP NUEVO USUARIO--
CREATE PROC SP_NUEVOUSUARIO (@ID_USU CHAR(8), @NOMBRES VARCHAR(30), @NOM_USU VARCHAR(10), @PASS_USU VARCHAR(15), @CORREO_USU VARCHAR(25),
@FECHA_NACI DATE,
@SEXO_USU   VARCHAR(10),
@ID_PAIS    CHAR(4) 
)
AS
INSERT INTO TB_USUARIO (ID_USU,NOMBRES,NOM_USU,PASS_USU,CORREO_USU,FECHA_NACI,SEXO_USU,ID_PAIS)
       VALUES(@ID_USU,@NOMBRES,@NOM_USU,@PASS_USU,@CORREO_USU,@FECHA_NACI,@SEXO_USU,@ID_PAIS
)
GO

--SP LISTAXNOMBRE
CREATE PROC SP_LISTAUSUARIOXNOMBREE(@NOM VARCHAR(50))
AS
	SELECT U.ID_USU,U.NOMBRES,U.NOM_USU,U.PASS_USU,U.CORREO_USU,U.FECHA_NACI,U.SEXO_USU,P.NOMBRE_PA
	FROM TB_USUARIO U  JOIN TB_PAIS P ON U.ID_PAIS=P.ID_PAIS
	WHERE U.NOMBRES like @NOM+'%'
GO

--ULTIMO CODIGO USUARIO
CREATE PROC SP_ULTIMOCODIGOUSUARIOO
AS
	SELECT * FROM TB_USUARIO WHERE ID_USU=(SELECT max(ID_USU) FROM TB_USUARIO)
GO

--SP ELIMINAR USUARIO
CREATE PROC SP_ELIMINARUSUARIOO(@ID CHAR(8))
AS
	DELETE FROM TB_USUARIO WHERE ID_USU = @ID
GO

-----------------------------------------------------------------------------------------------------------------
--METODOS DE LOGIN

CREATE PROC SP_INGRESOUSUARI0(@IDUSU VARCHAR(50), @PASS VARCHAR(10))
AS
	SELECT * FROM TB_USUARIO
	where NOM_USU = @IDUSU and PASS_USU = @PASS
GO